<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventaire - Astoria</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Main inventory wrapper -->
    <div class="inventory-wrapper">
        <!-- Header with title and back button -->
        <div class="inventory-header">
            <a href="index.html" class="back-link" title="Retour √† la liste">‚Üê</a>
            <h1 class="inventory-title">Inventaire</h1>
            <div class="inventory-actions">
                <span id="itemCount" class="inventory-info">0 objets</span>
            </div>
        </div>

        <!-- Category filter bar -->
        <div class="inventory-categories">
            <button class="category-btn active" data-category="all">
                <span class="category-icon">üì¶</span>
                <span class="category-label">Tous</span>
            </button>
            <button class="category-btn" data-category="equipement">
                <span class="category-icon">‚öîÔ∏è</span>
                <span class="category-label">√âquipements</span>
            </button>
            <button class="category-btn" data-category="consommable">
                <span class="category-icon">üß™</span>
                <span class="category-label">Consommables</span>
            </button>
            <button class="category-btn" data-category="agricole">
                <span class="category-icon">üåæ</span>
                <span class="category-label">Agricole</span>
            </button>
        </div>

        <!-- Main content area: grid + details -->
        <div class="inventory-content">
            <!-- Items grid (left side) -->
            <div class="inventory-grid-container">
                <div class="inventory-grid" id="inventoryGrid">
                    <!-- Items will be rendered here by JS -->
                </div>
                <div class="empty-inventory" id="emptyState" style="display: none;">
                    <div class="empty-state-icon">üì¶</div>
                    <div class="empty-state-title">Aucun objet</div>
                    <div class="empty-state-message">Votre inventaire est vide dans cette cat√©gorie</div>
                </div>
            </div>

            <!-- Item detail panel (right side) -->
            <div class="inventory-detail" id="itemDetail">
                <div class="detail-placeholder">
                    <div class="placeholder-icon">üëÜ</div>
                    <p>S√©lectionnez un objet pour voir ses d√©tails</p>
                </div>
                <!-- Details will be rendered here when item is selected -->
            </div>
        </div>
    </div>

    <!-- Load shared data -->
    <script src="data.js"></script>

    <!-- Inventory-specific JS -->
    <script>
        /**
         * DYNAMIC INVENTORY MODULE
         * - Loads all items from data.js (inventoryData)
         * - Uses localStorage to track quantities/modifications
         * - Category filtering & item selection
         * - All items loaded by default with full data
         */

        // =================================================================
        // CONFIGURATION
        // =================================================================

        /**
         * IMAGE CONFIGURATION
         * Maps item names/keys to actual image paths
         * Add new mappings here as needed
         */
        const IMAGE_CONFIG = {
            basePath: 'assets/images/',
            // Map item name (normalized) to filename
            mappings: {
                'poudrededetracage': 'Poudre_de_Tracage.png',
                'larmedematera': 'Larme_de_Matera.png',
                'fruitpapooru': 'Fruit_Papooru.jpg',
                'fioledevitalite': 'Fiole_de_vitalite.jpg',
                'parchemindeveil': 'Parchemin_Eveil.jpg',
                'parcheminascension': 'Parchemin_Ascension.jpg',
                'clefmanndorf': 'Clef_Manndorf.png',
                'armuredevexarion': 'Armure_de_Vexarion.png',
                'sceptredekrythus': 'Sceptre_de_Krythus.png',
                'capedelaubevermeille': 'Cape_de_lAube_Vermeille_off.jpg',
                'bookofaeris': 'Book_of_Aeris.png',
                'thequeenspoison': 'The_Queens_Poison.png',
                'clochederesonnance': 'Cloche_de_Resonnance.png',
                'veillenuit': 'VeilleNuit.png'
            }
        };

        /**
         * PLACEHOLDER IMAGE (SVG)
         * Shown when no image or image fails to load
         */
        const PLACEHOLDER_IMAGE =
            "data:image/svg+xml;utf8," +
            encodeURIComponent(
                `<svg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'>` +
                `<rect width='80' height='80' fill='#f0f0f0'/>` +
                `<text x='50%' y='50%' text-anchor='middle' dy='0.3em' fill='#d81b60' font-family='Arial' font-size='14'>?</text>` +
                `</svg>`
            );

        // =================================================================
        // STATE
        // =================================================================

        let currentCategory = 'all';
        let selectedItemIndex = null;
        let inventoryItems = [];
        let nextItemId = 1; // Auto-increment ID for new items

        // =================================================================
        // DOM REFERENCES
        // =================================================================

        const grid = document.getElementById('inventoryGrid');
        const detailPanel = document.getElementById('itemDetail');
        const emptyState = document.getElementById('emptyState');
        const itemCountEl = document.getElementById('itemCount');
        const categoryButtons = document.querySelectorAll('.category-btn');

        // =================================================================
        // INITIALIZATION
        // =================================================================

        /**
         * Initialize inventory from data.js
         * - Loads all items from inventoryData (shared data)
         * - Merges with localStorage quantities if available
         * - Renders the UI
         */
        function initInventory() {
            console.log('Initializing inventory from data.js...');

            // Load items from shared data.js
            loadFromDataJS();

            // Render
            renderInventory();
        }

        // =================================================================
        // PERSISTENCE - LocalStorage
        // =================================================================

        /**
         * Load inventory from data.js (inventoryData)
         * - Uses all items from shared data
         * - Merges with localStorage quantities if they exist
         * - Each item gets quantity: 1 by default
         */
        function loadFromDataJS() {
            try {
                // Check if inventoryData exists (from data.js)
                if (typeof inventoryData === 'undefined' || !inventoryData) {
                    console.warn('inventoryData not found in data.js');
                    inventoryItems = [];
                    return;
                }

                // Load stored quantities from localStorage
                const stored = localStorage.getItem('astoriaInventoryQuantities');
                let storedQuantities = {};
                if (stored) {
                    storedQuantities = JSON.parse(stored);
                    console.log('Loaded quantity data from storage');
                }

                // Transform inventoryData items with quantities
                inventoryItems = inventoryData.map((item, index) => {
                    const itemKey = item.name.toLowerCase().replace(/[^a-z0-9]/g, '');
                    return {
                        ...item,
                        id: index,
                        quantity: storedQuantities[itemKey] || 1 // Default quantity: 1
                    };
                });

                nextItemId = inventoryItems.length;
                console.log(`Loaded ${inventoryItems.length} items from data.js`);

            } catch (error) {
                console.error('Error loading from data.js:', error);
                inventoryItems = [];
            }
        }

        /**
         * Save quantities to localStorage
         * - Only saves quantities, not full item data
         * - Item data always comes from data.js
         */
        function saveQuantitiesToStorage() {
            try {
                const quantities = {};
                inventoryItems.forEach(item => {
                    const itemKey = item.name.toLowerCase().replace(/[^a-z0-9]/g, '');
                    quantities[itemKey] = item.quantity;
                });
                localStorage.setItem('astoriaInventoryQuantities', JSON.stringify(quantities));
                console.log('Quantities saved to localStorage');
            } catch (error) {
                console.error('Error saving to localStorage:', error);
            }
        }

        // =================================================================
        // CATEGORY FILTERING
        // =================================================================

        /**
         * Filter inventory by category
         * - Updates active button
         * - Clears selection
         * - Re-renders grid
         */
        function filterByCategory(category) {
            currentCategory = category;
            selectedItemIndex = null;

            // Update active button
            categoryButtons.forEach(btn => {
                if (btn.dataset.category === category) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            renderInventory();
        }

        // Attach click handlers to category buttons
        categoryButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                filterByCategory(btn.dataset.category);
            });
        });

        // =================================================================
        // IMAGE RESOLUTION
        // =================================================================

        /**
         * Resolve image path from item data
         * - Checks IMAGE_CONFIG mappings
         * - Supports direct URLs
         * - Falls back to placeholder
         */
        function resolveImage(item) {
            if (!item.image) {
                return PLACEHOLDER_IMAGE;
            }

            // If it's already a full URL or data URI, use it
            if (item.image.startsWith('http') || item.image.startsWith('data:')) {
                return item.image;
            }

            // If it's a direct filename with extension
            if (item.image.includes('.')) {
                return IMAGE_CONFIG.basePath + item.image;
            }

            // Try to find in mappings (normalize name)
            const normalized = item.image
                .toLowerCase()
                .replace(/[^a-z0-9]/g, '');

            if (IMAGE_CONFIG.mappings[normalized]) {
                return IMAGE_CONFIG.basePath + IMAGE_CONFIG.mappings[normalized];
            }

            // Try the item name as fallback
            const normalizedName = item.name
                .toLowerCase()
                .replace(/[^a-z0-9]/g, '');

            if (IMAGE_CONFIG.mappings[normalizedName]) {
                return IMAGE_CONFIG.basePath + IMAGE_CONFIG.mappings[normalizedName];
            }

            // No match found, use placeholder
            return PLACEHOLDER_IMAGE;
        }

        // =================================================================
        // RENDERING
        // =================================================================

        /**
         * Render the entire inventory grid
         * - Filters by current category
         * - Updates item count
         * - Shows empty state if needed
         * - Creates item cards
         */
        function renderInventory() {
            // Filter items by category
            let filtered = inventoryItems;
            if (currentCategory !== 'all') {
                filtered = inventoryItems.filter(item => item.category === currentCategory);
            }

            // Update count (shows currently filtered count)
            itemCountEl.textContent = `${filtered.length} objet${filtered.length > 1 ? 's' : ''}`;

            // Clear grid
            grid.innerHTML = '';

            // Show empty state if no items
            if (filtered.length === 0) {
                grid.style.display = 'none';
                emptyState.style.display = 'flex';
                showDetailPlaceholder();
                return;
            }

            // Show grid
            grid.style.display = 'grid';
            emptyState.style.display = 'none';

            // Render each item
            filtered.forEach((item) => {
                const card = createItemCard(item);
                grid.appendChild(card);
            });
        }

        /**
         * Create an item card element
         * - Resolves image
         * - Shows quantity if > 1
         * - Attaches click handler
         */
        function createItemCard(item) {
            const card = document.createElement('div');
            card.className = 'inventory-item';
            card.dataset.itemId = item.id;

            // Resolve image
            const imageSrc = resolveImage(item);

            card.innerHTML = `
                <div class="item-image">
                    <img src="${escapeHtml(imageSrc)}"
                         alt="${escapeHtml(item.name)}"
                         onerror="this.src='${PLACEHOLDER_IMAGE}'">
                </div>
                <div class="item-info">
                    <div class="item-name">${escapeHtml(item.name)}</div>
                    ${item.quantity > 1 ? `<div class="item-quantity">√ó${item.quantity}</div>` : ''}
                </div>
            `;

            // Click to select
            card.addEventListener('click', () => selectItem(item, card));

            return card;
        }

        // =================================================================
        // ITEM SELECTION & DETAILS
        // =================================================================

        /**
         * Select an item and show its details
         * - Removes previous selection
         * - Marks new selection
         * - Updates detail panel
         */
        function selectItem(item, cardElement) {
            // Remove previous selection
            document.querySelectorAll('.inventory-item').forEach(el => {
                el.classList.remove('selected');
            });

            // Mark as selected
            cardElement.classList.add('selected');
            selectedItemIndex = item.id;

            // Show details
            showItemDetail(item);
        }

        /**
         * Show item details in right panel
         * - Resolves image
         * - Shows all item properties
         */
        function showItemDetail(item) {
            const categoryLabels = {
                'equipement': '‚öîÔ∏è √âquipement',
                'consommable': 'üß™ Consommable',
                'agricole': 'üåæ Agricole'
            };

            const priceInfo = [];
            if (item.buyPrice) priceInfo.push(`Achat: ${item.buyPrice}`);
            if (item.sellPrice) priceInfo.push(`Vente: ${item.sellPrice}`);
            const priceText = priceInfo.length > 0 ? priceInfo.join(' | ') : 'Prix non d√©fini';

            // Resolve image
            const imageSrc = resolveImage(item);

            detailPanel.innerHTML = `
                <div class="detail-header">
                    <h2 class="detail-title">${escapeHtml(item.name)}</h2>
                    <span class="detail-category">${categoryLabels[item.category] || 'Autre'}</span>
                </div>
                <div class="detail-image">
                    <img src="${escapeHtml(imageSrc)}"
                         alt="${escapeHtml(item.name)}"
                         onerror="this.src='${PLACEHOLDER_IMAGE}'">
                </div>
                <div class="detail-body">
                    <div class="detail-section">
                        <span class="detail-label">Description</span>
                        <p class="detail-text">${escapeHtml(item.description || 'Aucune description disponible.')}</p>
                    </div>
                    ${item.effect ? `
                    <div class="detail-section">
                        <span class="detail-label">Effet</span>
                        <p class="detail-text detail-effect">${escapeHtml(item.effect)}</p>
                    </div>
                    ` : ''}
                    <div class="detail-section">
                        <span class="detail-label">Commerce</span>
                        <p class="detail-text">${escapeHtml(priceText)}</p>
                    </div>
                    ${item.quantity > 1 ? `
                    <div class="detail-section">
                        <span class="detail-label">Quantit√©</span>
                        <p class="detail-text">√ó${item.quantity}</p>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        /**
         * Show placeholder when no item selected
         */
        function showDetailPlaceholder() {
            detailPanel.innerHTML = `
                <div class="detail-placeholder">
                    <div class="placeholder-icon">üëÜ</div>
                    <p>S√©lectionnez un objet pour voir ses d√©tails</p>
                </div>
            `;
        }

        // =================================================================
        // UTILITIES
        // =================================================================

        /**
         * Escape HTML to prevent XSS
         */
        function escapeHtml(str) {
            if (!str) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // =================================================================
        // ENTRY POINT
        // =================================================================

        /**
         * Initialize on page load
         */
        window.addEventListener('DOMContentLoaded', initInventory);

        /**
         * Expose API for external use
         * - Can be called from index.html or other pages
         * - Example: InventoryModule.addItemFromExternal(item)
         */
        window.InventoryModule = {
            // Current state
            items: () => inventoryItems,

            // Core functions
            renderInventory,
            filterByCategory,

            // Update item quantity
            updateQuantity: (itemName, newQuantity) => {
                const item = inventoryItems.find(i => i.name === itemName);
                if (item) {
                    item.quantity = Math.max(0, newQuantity);
                    saveQuantitiesToStorage();
                    renderInventory();
                }
            },

            // Reset quantities to default (1 for all)
            resetQuantities: () => {
                if (confirm('R√©initialiser toutes les quantit√©s √† 1 ?')) {
                    inventoryItems.forEach(item => item.quantity = 1);
                    saveQuantitiesToStorage();
                    renderInventory();
                    console.log('Quantities reset to 1');
                }
            },

            // Reload from data.js (discards localStorage)
            reloadFromData: () => {
                localStorage.removeItem('astoriaInventoryQuantities');
                loadFromDataJS();
                renderInventory();
                console.log('Reloaded from data.js');
            }
        };
    </script>
</body>
</html>
